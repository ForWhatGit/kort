<!DOCTYPE html>
<html lang="en">
	<head>
		<%- include('../partials/header.ejs') %>
		<title>Edit Card Sort</title>
		<script>
			$( document ).ready(function() {
			    $("[name='studyType']").change(function() {
				  $("#groupInputArea").toggle();
				});
				 $("[name='private']").change(function() {
				  $("#responseListArea").toggle();
				});
				//group input area is hidden by default, if study is 'closed' - toggle it to be visble
				//this might be difficut to include in an external js file todo.
				<%if (singleStudy.private == true) { %>
					$("#responseListArea").toggle();
				<% } %>
				<%if (singleStudy.data.studyType == 'closed') { %>
					$("#groupInputArea").toggle();
				<% } %>
				$('#createNewResponseBtn').on('click', function(event) {
			      	$.ajax({
				        url: '/createresponse_ajax/<%= singleStudy._id %>',
				        type: "POST",
				        contentType: "application/json",
				        success: function(response) {
				          	$(`<tr>
							<td><a href='<%= url %>/cardsort/<%= singleStudy._id %>/`+response._id+`'><%= url %>/cardsort/<%= singleStudy._id %>/`+response._id+`</td>
							</tr>`).appendTo($('#responses_table_body'));
				        },
				        error:   function(xhr, text, err) {
			          		console.log("Response: Please check ajax request");
				        }
			      	});
			    });  

			});
		</script>
	</head>
	<body>
	<%- include('../partials/admin_header.ejs') %>
	<div class="container">
		<h1><%= title %> Cardsort</h1>
				<hr>
		<form method="POST" action="/updatecardsort">
			<input hidden name='id' value='<%= singleStudy._id %>' />
			<div class='row'>
				<div class='col-sm-4'>
					<%- include('../partials/study_options/title.ejs') %>
					<%- include('../partials/study_options/status.ejs') %>
					<div class="well">
					    <label for="title">Card Sort Study Type</label><br>
					    <p>Set this to "open" if you want participants to be able to add new groups and change the names of existing.</p>
					    <%if (singleStudy.data.studyType == 'open') { %>
						    <div class="radio">
						     	<label><input type="radio" name="studyType" value='open' checked>Open</label>
						    </div>
						    <div class="radio">
								<label><input type="radio" name="studyType" value='closed'>Closed</label>
						    </div>
					    <% } else { %> 
						    <div class="radio">
						     	<label><input type="radio" name="studyType" value='open'>Open</label>
						    </div>
						    <div class="radio">
								<label><input type="radio" name="studyType" value='closed' checked>Closed</label>
						    </div></p>
					    <% } %>
					</div>
				</div>
				<div class='col-sm-4'>
					<div class="well">
						<label for="cards">Cards</label>
						<br>
						<textarea name="cards" rows="15" cols="30" id="cards"><% for(var j=0; j<singleStudy.data.cards.length; j++) {%><%= singleStudy.data.cards[j]+'\n' %><% } %></textarea>
					</div>
				</div>
				<div class='col-sm-4'>
					<div id='groupInputArea' hidden>
						<div class="well">
							<label for="groups">Groups</label><br>
							<textarea name="groups" rows="15" cols="30" id="groups"><% for(var j=0; j<singleStudy.data.groups.length; j++) {%><%= singleStudy.data.groups[j]+'\n' %><% } %></textarea>
						</div>
					</div>
				</div>	
			</div>
			<div class='row well'>
				<%- include('../partials/study_options/private.ejs') %>
				<div id='responseListArea' hidden>
			  		<table class="table">
						<thead>
							<tr>
								<th>URL</th>
								<th>Complete</th>
								<th>Delete</th>
							</tr>
						</thead>
						<tbody id="responses_table_body">
						<% for(var z=0; z < singleStudy.incompleteResponses.length; z++) {%>
							<tr>
								<td><a href='<%= url %>/cardsort/<%= singleStudy._id %>/<%= singleStudy.incompleteResponses[z]._id %>'><%= url %>/cardsort/<%= singleStudy._id %>/<%= singleStudy.incompleteResponses[z]._id %></a></td>
								<td><%= singleStudy.incompleteResponses[z].complete %></a></td>
								<td>Delete</td>
							</tr>
						<% } %>
						</tbody>
					</table>
					<div style="background-color: white">
						<button type="button" id='createNewResponseBtn'>Add Response</button>
					</div>
				</div>
			</div>

			<div class='row'>
				<div class='col-sm-4'>
					<button type="submit" class="btn btn-primary">Save</button>
					<%if (title == 'Edit') { %>
					<a href="/studies" class="btn btn-default" role="button">Cancel</a>
					<% } else {%>
					<a href="/deletestudy/<%= singleStudy._id %>" class="btn btn-default" role="button">Cancel</a>
					<% } %>
				</div>
			</div>
		</form>
		
		
	</div>			
	
	</body>
</html>
